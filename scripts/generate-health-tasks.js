/**
 * å¥åº·å»ºè®®ä»»åŠ¡ç”Ÿæˆå™¨
 * ä¸ºç¨‹åºå‘˜ç”Ÿæˆé’ˆå¯¹æ€§çš„å¥åº·æé†’å’Œå»ºè®®
 */

const AITaskGenerator = require('./ai-task-generator');
const EmailSender = require('./email-sender');

async function generateHealthTasks() {
  const generator = new AITaskGenerator();
  const emailSender = new EmailSender();

  try {
    const timeContext = generator.getTimeContext();

    const prompt = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„èŒä¸šå¥åº·é¡¾é—®ï¼Œä¸“é—¨ä¸ºç¨‹åºå‘˜å’ŒçŸ¥è¯†å·¥ä½œè€…æä¾›å¥åº·å»ºè®®ã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä»Šå¤©çš„å¥åº·æé†’:

**æ—¶é—´ä¿¡æ¯:**
- å½“å‰æ—¶é—´: ${timeContext.date} ${timeContext.dayOfWeek} ${timeContext.timeOfDay}
- å½“å‰å°æ—¶: ${timeContext.hour}
- æ˜¯å¦å‘¨æœ«: ${timeContext.isWeekend ? 'æ˜¯' : 'å¦'}

**ç¨‹åºå‘˜å¥åº·é‡ç‚¹é¢†åŸŸ:**
1. **çœ¼éƒ¨å¥åº·** - é•¿æ—¶é—´çœ‹å±å¹•å¯¼è‡´çš„çœ¼ç–²åŠ³
2. **é¢ˆæ¤è„Šæ¤** - é•¿æœŸåå§¿ä¸è‰¯é€ æˆçš„é—®é¢˜
3. **å¿ƒç†å¥åº·** - å·¥ä½œå‹åŠ›å’Œç„¦è™‘ç®¡ç†
4. **è¿åŠ¨å¥èº«** - ä¹…åç”Ÿæ´»æ–¹å¼çš„æ”¹å–„
5. **è¥å…»é¥®é£Ÿ** - è„‘åŠ›å·¥ä½œè€…çš„è¥å…»éœ€æ±‚
6. **ç¡çœ è´¨é‡** - è§„å¾‹ä½œæ¯å’Œç¡çœ ä¼˜åŒ–
7. **ç¤¾äº¤å¥åº·** - é¿å…è¿‡åº¦å­¤ç«‹ï¼Œä¿æŒäººé™…è”ç³»

**æ—¶é—´æ®µç‰¹æ®Šè€ƒè™‘:**
- å¦‚æœæ˜¯æ—©æ™¨: é‡ç‚¹å…³æ³¨ä¸€å¤©çš„å¥åº·è®¡åˆ’è®¾å®š
- å¦‚æœæ˜¯ä¸‹åˆ: å…³æ³¨å·¥ä½œä¸­çš„å¥åº·ä¹ æƒ¯
- å¦‚æœæ˜¯æ™šä¸Š: å…³æ³¨æ”¾æ¾å’Œæ¢å¤

**è¾“å‡ºæ ¼å¼:**
\`\`\`json
{
  "health_theme": "ä»Šæ—¥å¥åº·ä¸»é¢˜",
  "priority_areas": ["é‡ç‚¹å…³æ³¨çš„å¥åº·é¢†åŸŸ"],
  "tasks": [
    {
      "title": "å¥åº·ä»»åŠ¡æ ‡é¢˜",
      "category": "çœ¼éƒ¨å¥åº·/é¢ˆæ¤è„Šæ¤/å¿ƒç†å¥åº·/è¿åŠ¨å¥èº«/è¥å…»é¥®é£Ÿ/ç¡çœ è´¨é‡/ç¤¾äº¤å¥åº·",
      "description": "å…·ä½“çš„å¥åº·å»ºè®®å’Œè¯´æ˜",
      "action_items": ["å…·ä½“æ‰§è¡Œæ­¥éª¤1", "å…·ä½“æ‰§è¡Œæ­¥éª¤2"],
      "timing": "å»ºè®®æ‰§è¡Œæ—¶é—´",
      "duration": "æŒç»­æ—¶é—´",
      "frequency": "æ‰§è¡Œé¢‘ç‡",
      "benefits": "é¢„æœŸå¥åº·ç›Šå¤„",
      "difficulty": "easy/medium/hard"
    }
  ],
  "daily_reminders": ["å…¨å¤©å¥åº·æé†’"],
  "emergency_signals": ["éœ€è¦ç«‹å³å…³æ³¨çš„å¥åº·è­¦ç¤ºä¿¡å·"],
  "motivation": "ä»Šæ—¥å¥åº·åŠ±å¿—è¯­"
}
\`\`\`

**ç‰¹åˆ«è¦æ±‚:**
- æä¾›å…·ä½“å¯è¡Œçš„å¥åº·è¡ŒåŠ¨å»ºè®®
- è€ƒè™‘ç¨‹åºå‘˜çš„å·¥ä½œç‰¹ç‚¹å’Œæ—¶é—´é™åˆ¶
- åŒ…å«é¢„é˜²æ€§å»ºè®®å’Œå³æ—¶ç¼“è§£æ–¹æ³•
- æä¾›ç®€å•æ˜“è¡Œçš„åŠå…¬å®¤å¥åº·æ“ä½œ
- å¼ºè°ƒå¯æŒç»­çš„å¥åº·ä¹ æƒ¯å…»æˆ

è¯·æ ¹æ®å½“å‰æ—¶é—´${timeContext.timeOfDay}ï¼Œè°ƒæ•´å»ºè®®çš„é‡ç‚¹å’Œç´§æ€¥ç¨‹åº¦ã€‚
`;

    const taskData = await generator.generateTasks(prompt, 'health');

    const emailContent = `
# ğŸ’ª ä»Šæ—¥å¥åº·æé†’ - ${timeContext.date}

## å¥åº·æ¦‚è§ˆ
- å¥åº·ä¸»é¢˜: ç¨‹åºå‘˜ä¸“é¡¹å¥åº·ç®¡ç†
- æ—¶é—´æ®µ: ${timeContext.timeOfDay}
- ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}

## ä»Šæ—¥å¥åº·ä»»åŠ¡

${taskData.tasks.map((task, index) => `
### ${index + 1}. ${task.title || 'å¥åº·ä»»åŠ¡'}

**ç±»åˆ«**: ${task.category || 'ç»¼åˆå¥åº·'}
**éš¾åº¦**: ${task.difficulty || 'ç®€å•'}
**å»ºè®®æ—¶é—´**: ${task.timing || 'éšæ—¶å¯åš'}
**æŒç»­æ—¶é—´**: ${task.duration || '5-10åˆ†é’Ÿ'}

**è¯¦ç»†è¯´æ˜**:
${task.description || 'ä¿æŒèº«ä½“å¥åº·'}

**æ‰§è¡Œæ­¥éª¤**:
${task.action_items ? task.action_items.map(item => `- ${item}`).join('\n') : '- æŒ‰ç…§å»ºè®®æ‰§è¡Œ'}

**å¥åº·ç›Šå¤„**:
${task.benefits || 'æ”¹å–„æ•´ä½“å¥åº·çŠ¶å†µ'}

**æ‰§è¡Œé¢‘ç‡**: ${task.frequency || 'æ¯æ—¥ä¸€æ¬¡'}

`).join('\n---\n')}

## ğŸ”” å…¨å¤©å¥åº·æé†’
- æ¯å°æ—¶èµ·èº«æ´»åŠ¨5åˆ†é’Ÿ
- ä¿æŒæ­£ç¡®åå§¿ï¼Œæ˜¾ç¤ºå™¨ä¸çœ¼ç›å¹³è¡Œ
- å®šæ—¶è¿œçœºæ”¾æ¾çœ¼éƒ¨è‚Œè‚‰
- å¤šå–æ°´ï¼Œå°‘å–å’–å•¡å’Œå«ç³–é¥®æ–™
- æ³¨æ„æ·±å‘¼å¸ï¼Œç¼“è§£å·¥ä½œå‹åŠ›

## âš ï¸ å¥åº·è­¦ç¤ºä¿¡å·
è¯·æ³¨æ„ä»¥ä¸‹ç—‡çŠ¶ï¼Œå¦‚å‡ºç°è¯·åŠæ—¶ä¼‘æ¯æˆ–å°±åŒ»:
- çœ¼éƒ¨å¹²æ¶©ã€è§†åŠ›æ¨¡ç³ŠæŒç»­ä¸ç¼“è§£
- é¢ˆè‚©è…°èƒŒç–¼ç—›åŠ å‰§
- è¿ç»­å‡ å¤©ç¡çœ è´¨é‡å·®
- æƒ…ç»ªæŒç»­ä½è½æˆ–ç„¦è™‘
- é£Ÿæ¬²æ˜æ˜¾ä¸‹é™

## ğŸ’¡ ä»Šæ—¥å¥åº·æ ¼è¨€
> "ç¨‹åºå¯ä»¥debugï¼Œä½†èº«ä½“æ²¡æœ‰å›æ»šåŠŸèƒ½ã€‚æŠ•èµ„å¥åº·ï¼Œå°±æ˜¯æŠ•èµ„æœªæ¥çš„ç”Ÿäº§åŠ›ï¼"

## AIå¥åº·å»ºè®®è¯¦æƒ…
${taskData.ai_response}

---
*ç”±AI Jarviså¥åº·åŠ©æ‰‹ç”Ÿæˆ - å¥åº·çš„èº«ä½“æ˜¯é«˜æ•ˆç¼–ç¨‹çš„åŸºç¡€ï¼*
`;

    await emailSender.sendEmail(
      'ğŸ’ª ä»Šæ—¥å¥åº·æé†’',
      emailContent
    );

    console.log('âœ… Health tasks generated and sent successfully');
    console.log(`Generated ${taskData.tasks.length} health tasks`);

  } catch (error) {
    console.error('âŒ Error generating health tasks:', error.message);

    const emailSender = new EmailSender();
    await emailSender.sendEmail(
      'ğŸš¨ å¥åº·æé†’ç”Ÿæˆå¤±è´¥',
      `å¥åº·æé†’ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:\n\n${error.message}\n\nè¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®ã€‚`
    );
  }
}

if (require.main === module) {
  generateHealthTasks();
}

module.exports = generateHealthTasks;